# Лабораторная работа №2 — Сервис бронирования отелей

## Цель работы
Разработать веб-приложение на Django для отображения списка отелей и типов номеров, организации бронирований и отзывов, а также реализовать административные действия (заселение/выселение) и отчётную таблицу по постояльцам за последний месяц. Дополнительно: меню Bootstrap, пагинация и поиск.

---

## Задание 1. Список отелей

### Реализованный функционал
На сайте реализована главная страница со списком отелей. Для каждого отеля учитываются:
- **Название** (`Hotel.name`)
- **Владелец** (`Hotel.owner` — связь с пользователем)
- **Адрес** (`Hotel.address`)
- **Описание** (`Hotel.description`)
- **Типы номеров отеля** (связь через `HotelRoomType`)
- Для каждого типа номера в отеле отображаются:
  - **Стоимость за ночь** (`HotelRoomType.price_per_night`)
  - **Вместимость** (`HotelRoomType.capacity`)
  - **Удобства** (через `RoomType.amenities` → `Amenity`)
  - **Количество доступных мест/номеров** (на уровне модели: `available_units`)

### Реализация
- Представление:
  - `HotelListView(ListView)` — список отелей с пагинацией и поиском
  - `hotel_detail(request, hotel_id)` — детальная страница отеля, вывод типов номеров в отеле
- Шаблоны:
  - `templates/hotel_list.html`
  - `templates/hotel_detail.html`
- URL:
  - `/` и `/hotels/` — список отелей
  - `/hotels/<int:hotel_id>/` — страница конкретного отеля

### Особенности
- Типы номеров на странице отеля **сортируются по возрастанию цены** (`order_by("price_per_night")`).
- Тип номера в отеле реализован отдельной сущностью (`HotelRoomType`), которая хранит параметры типа номера **именно для конкретного отеля**.

---

## Задание 2. Регистрация новых пользователей

### Реализованный функционал
Реализована регистрация пользователей через `SignUpView` на основе `UserCreationForm` (расширенная форма). После регистрации пользователь может входить в систему и пользоваться функционалом бронирований и отзывов.

### Реализация
- Представление:
  - `SignUpView(CreateView)` в `views.py`
- Форма:
  - `CustomUserCreationForm` в `forms.py`
- Шаблон:
  - `templates/registration/signup.html`
- URL:
  - `/accounts/signup/`

---

## Задание 3. Просмотр и резервирование номеров (типов номеров)

### Реализованный функционал
Пользователь может:
- Просматривать страницу типа номера в отеле (страница “номера”)
- Создавать бронирование на период (`BOOKED`)
- Отменять (удалять по логике) свои бронирования через смену статуса на `CANCELED`
- Редактировать даты бронирования (только если бронь в статусе `BOOKED`)

### Реализация
- Представления:
  - `room_detail(request, room_id)` — просмотр типа номера в отеле + создание/отмена бронирования
  - `reservation_edit(request, reservation_id)` — редактирование дат бронирования
- Формы:
  - `ReservationCreateForm` — создание бронирования
  - `ReservationUpdateForm` — редактирование дат
- Шаблоны:
  - `templates/room_detail.html`
  - `templates/reservation_edit.html`
- URL:
  - `/rooms/<int:room_id>/` — страница типа номера в отеле (`room_id` = `HotelRoomType.id`)
  - `/reservations/<int:reservation_id>/edit/` — редактирование бронирования

### Проверка доступности на выбранные даты
При бронировании реализована проверка:
- вычисляется количество пересекающихся активных бронирований (`BOOKED`, `CHECKED_IN`) по интервалам дат;
- если пересечений **>= `total_units`**, то выводится сообщение: *“No availability for the selected dates.”*
- если мест достаточно — бронь создаётся.

### Ограничения
- Редактирование доступно **только** при статусе `BOOKED`
- Если бронь `CHECKED_IN`, `CHECKED_OUT` или `CANCELED` — редактирование недоступно.

---

## Задание 4. Отзывы к номерам

### Реализованный функционал
Пользователь может:
- Просматривать отзывы к выбранному типу номера в отеле
- Оставлять отзыв (если авторизован)

При добавлении отзыва сохраняются:
- Период проживания: `stay_from`, `stay_to`
- Текст отзыва: `text`
- Рейтинг 1–10: `rating` (валидация `MinValueValidator` и `MaxValueValidator`)
- Автор отзыва: `author` (связь с пользователем)
- Дата создания: `created_at`

### Реализация
- Модель:
  - `Review` (связь с `HotelRoomType`)
- Представление:
  - добавление отзыва встроено в `room_detail` (action = `add_review`)
- Форма:
  - `ReviewForm` в `forms.py`
- Шаблон:
  - блок отзывов в `templates/room_detail.html`

---

## Задание 5. Заселение и выселение пользователя администратором (Django-admin)

### Реализованный функционал
Администратор может заселить и выселить пользователя средствами Django-admin:
- Заселение переводит бронь в статус `CHECKED_IN`
- Выселение переводит бронь в статус `CHECKED_OUT`
- При заселении/выселении обновляется счётчик **фактически занятых номеров**:
  - `HotelRoomType.occupied_units` увеличивается при check-in
  - уменьшается при check-out

### Реализация
- Методы модели `Reservation`:
  - `mark_checked_in()`
  - `mark_checked_out()`
- Django-admin:
  - `ReservationAdmin` с **admin-actions**:
    - `Check-in selected reservations`
    - `Check-out selected reservations`

---

## Задание 6. Таблица постояльцев отеля за последний месяц (клиентская часть)

### Реализованный функционал
Реализована клиентская страница, отображающая таблицу постояльцев выбранного отеля за последние 30 дней. В таблице отображается:
- Пользователь (username)
- Тип номера
- Даты заезда/выезда
- Статус бронирования

Выбираются бронирования со статусами `CHECKED_IN` и `CHECKED_OUT`, у которых период проживания пересекается с последними 30 днями.

### Реализация
- Представление:
  - `hotel_guests_last_month(request, hotel_id)`
- Шаблон:
  - `templates/hotel_guests_last_month.html`
- URL:
  - `/hotels/<int:hotel_id>/guests-last-month/`

---

## Задание 7. Меню (Bootstrap navigation menu)

### Реализованный функционал
Добавлено общее меню (navbar) на всех страницах сайта:
- ссылка на главную страницу (Hotels)
- поле поиска
- отображение статуса пользователя:
  - если не авторизован: **Login / Sign up**
  - если авторизован: **Hello, username / Logout**
- ссылка на Django-admin

### Реализация
- Базовый шаблон:
  - `templates/base.html`
- Все страницы наследуются через:
  - `{% extends "base.html" %}`

---

## Задание 8. Пагинация страниц

### Реализованный функционал
Реализована пагинация списка отелей:
- выводится фиксированное количество объектов на страницу (например, 10)
- пользователь может переключаться по страницам через параметр `?page=2`

### Реализация
- Используется `ListView`:
  - `paginate_by = 10`
- Шаблон:
  - пагинация выводится через `bootstrap_pagination page_obj`

---

## Задание 9. Поиск по объектам с пагинацией

### Реализованный функционал
Поиск работает по объектам, которые выводятся на странице списка отелей с пагинацией:
- поиск выполняется через `GET` параметр `q`
- результаты поиска также пагинируются
- при переключении страниц поисковый запрос сохраняется в URL

### Реализация
- В `HotelListView.get_queryset()` используется фильтрация через `Q`:
  - `name__icontains`, `address__icontains`, `description__icontains`
- В контекст передаются:
  - `q` — текущий запрос
  - `last_q` — строка вида `?q=...` для корректной работы ссылок пагинации
- В шаблоне:
  - `{% bootstrap_pagination page_obj url=last_q %}`

---

## Заключение
В рамках лабораторной работы реализован полный набор требуемого функционала:
- каталог отелей и типов номеров с подробной информацией;
- регистрация и авторизация пользователей;
- бронирование с проверкой доступности по датам, отменой и редактированием;
- отзывы с рейтингом и периодом проживания;
- административные действия заселения/выселения через Django-admin;
- отчётная таблица постояльцев за последний месяц;
- меню Bootstrap, пагинация и поиск с сохранением параметров.