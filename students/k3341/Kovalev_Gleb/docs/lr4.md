# Лабораторная работа №4

## Реализованный функционал

### 1. Настройка CORS для серверной части
Для взаимодействия клиентского приложения на Vue (Vite) с сервером Django REST Framework настроен CORS.  
Это позволяет отправлять запросы с `http://localhost:5173` на `http://127.0.0.1:8000` и получать ответы без блокировок браузера.

---

### 2. Определение минимального списка интерфейсов
В клиентской части определены и реализованы интерфейсы под реальные роли системы.

**Интерфейсы аутентификации:**
- Регистрация клиента
- Регистрация персонала (уборщик/админ) по коду
- Вход (получение токена)
- Выход (удаление токена)
- Профиль пользователя (по роли)

**Интерфейсы для работы с данными:**
- Клиент: список отелей, список типов номеров, экран типа номера, бронирование на период, отмена брони, профиль со списком броней
- Уборщик: главный экран уборок (форма добавления уборки), список уборок за выбранный день, удаление записи
- Администратор:
  - Номера — список с пагинацией и фильтрами (тип, статус, уборка)
  - Заселения/бронирования — список бронирований с пагинацией и фильтрами, check-in/checkout, смена номера
  - Персонал — список уборщиков с пагинацией, статистика уборок за период, “увольнение”, список уборок с фильтрами и сменой статуса

---

### 3. Реализация интерфейсов авторизации, регистрации и изменения состояния аккаунта

#### 3.1. Компонент входа (Login.vue)
Реализован интерфейс входа в систему:

- Поля формы: `username`, `password`
- Отправка запроса на получение токена
- Сохранение токена в `localStorage` (через store)
- Получение профиля пользователя через endpoint `me`
- Перенаправление на главную страницу в зависимости от роли:
  - `client` → `/`
  - `cleaner` → `/cleaner`
  - `admin` → `/admin/rooms`
- Красивый вывод ошибок (неверный логин/пароль, сеть, деактивированный аккаунт)

**Используемые API endpoints:**
- `POST /api/auth/token/login/` — получение токена
- `GET /api/client/me/` — профиль (роль/отель/клиент/персонал)

#### 3.2. Компоненты регистрации (Register*.vue)
Реализовано разделение регистрации на три страницы:

**RegisterChoose.vue (выбор)**
- Кнопки: “Я клиент”, “Я персонал”
- Ссылка на вход

**RegisterClient.vue**
- Поля: `username`, `email`, `password`
- Валидация заполненности полей
- Отправка регистрации на Djoser/свой endpoint регистрации клиента
- Автоматический вход после регистрации
- Перенаправление по роли

**RegisterStaff.vue**
- Поля: `username`, `password`, `role (cleaner/admin)`, `hotel_id`, `code`
- Загрузка списка отелей
- Отправка регистрации персонала
- Автоматический вход после регистрации
- Перенаправление по роли

**Используемые API endpoints:**
- `POST /api/auth/users/` — регистрация клиента (Djoser)
- `POST /api/staff/register/` (или аналог) — регистрация персонала по коду
- `POST /api/auth/token/login/` — вход
- `GET /api/client/me/` — получение роли и связанных данных

#### 3.3. Хранение авторизации на клиенте
Реализован store (`authStore`) для управления состоянием:

- `token` хранится в `localStorage`
- `role` хранится в store и обновляется после запроса `me()`
- При выходе токен очищается, пользователь перенаправляется на `/login`
- Хедер отображает разные пункты меню в зависимости от роли

---

### 4. Реализация клиентских интерфейсов для работы с данными

#### 4.1. Главная страница отелей (Home.vue)
Реализован интерфейс просмотра отелей:

- Загрузка списка отелей с сервера
- Отображение карточек отелей с фото
- Переход на страницу отеля
- Пагинация (на клиенте или через серверную пагинацию, если включена)

**Используемые API endpoints:**
- `GET /api/hotels/` — список отелей

#### 4.2. Страница отеля + типы номеров (HotelDetail.vue)
Реализован интерфейс просмотра выбранного отеля:

- Карточка отеля (фото, город, адрес, кол-во номеров)
- Сетка типов номеров с фото
- Переход на страницу конкретного типа

**Используемые API endpoints:**
- `GET /api/hotels/{id}/room-types/` — список типов номеров в отеле (+ `total_rooms`, `free_rooms`)

#### 4.3. Экран типа номера (RoomTypeDetail.vue)
Реализован экран, на котором клиент может:

- Посмотреть информацию о типе номера
- Выбрать даты заезда/выезда
- Проверить доступность на период (`min_free_rooms` и `can_book`)
- Создать бронирование на период
- Увидеть существующую активную бронь на данный тип и отменить её (если статус “Забронирован” или “Ожидает оплату”)

**Используемые API endpoints:**
- `GET /api/hotels/{hotel_id}/room-types/{type_id}/` — детали типа
- `GET /api/hotels/{hotel_id}/room-types/{type_id}/availability/?start=YYYY-MM-DD&end=YYYY-MM-DD` — доступность
- `POST /api/hotels/{hotel_id}/room-types/{type_id}/book/` — бронь по типу на период
- `GET /api/client/my-bookings/` — мои бронирования
- `POST /api/client/bookings/{id}/cancel/` — отмена брони

#### 4.4. Профиль (Profile.vue) — по ролям
Реализован единый профиль, который показывает разный контент в зависимости от роли.

**Client:**
- Список бронирований
- Кнопка отмены брони для статусов “Забронирован”/“Ожидает оплату”

**Cleaner:**
- Вывод привязанного отеля
- Список уборок за выбранный день
- Удаление записи уборки (с синхронизацией `cleaned` в номере)

**Admin:**
- Вывод привязанного отеля
- Текстовая подсказка переходить в разделы “Номера/Заселения/Персонал”

**Используемые API endpoints:**
- `GET /api/client/me/` — профиль текущего пользователя
- `GET /api/client/my-bookings/` — брони клиента
- `POST /api/client/bookings/{id}/cancel/` — отмена
- `GET /api/cleaner/cleanings/?date=YYYY-MM-DD` — уборки за день
- `DELETE /api/cleaner/cleanings/{id}/` — удалить уборку

#### 4.5. Уборки (CleanerHome.vue)
Реализован функционал для уборщика:

- Выбор даты (день)
- Форма добавления уборки: номер, время, статус
- Список уборок за выбранный день
- Удаление записи уборки
- В списке выбора показываются только номера, которые не убраны (`cleaned=false` или `null`)
- При добавлении/удалении уборки обновляется `cleaned` у номера

**Используемые API endpoints:**
- `GET /api/cleaner/rooms/` — доступные для уборки номера (не убраны)
- `GET /api/cleaner/cleanings/?date=…` — список уборок за день
- `POST /api/cleaner/cleanings/` — добавить/обновить уборку
- `DELETE /api/cleaner/cleanings/{id}/` — удалить уборку

#### 4.6. Админ: Номера (AdminRooms.vue)
Реализован интерфейс управления номерами:

- Пагинация (`page`, `page_size`)
- Фильтрация:
  - по типу номера (`type_id`)
  - по статусу комнаты (Свободен/Занят)
  - по уборке (`cleaned=true/false`, где “не убран” включает `null`)
  - поиск по номеру комнаты
- Отображение информации: номер, тип, статус, уборка

**Используемые API endpoints:**
- `GET /api/admin/rooms/?page=…&page_size=…&type_id=…&status=…&cleaned=…&search=…`

#### 4.7. Админ: Заселения / Бронирования (AdminCheckins.vue)
Реализован интерфейс управления бронированиями:

**Пагинация и фильтрация:**
- статус (кроме “Отменен” и “Выселен”)
- тип номера
- пересечение по датам (`start`, `end`)
- поиск по клиенту (ФИО/email)

**Действия администратора:**
- Редактировать даты и статус (только “Забронирован”/“Ожидает оплату”)
- Заселить (check-in): выбрать конкретный номер того же типа  
  При заселении:
  - `booking.book_status = “Заселен”`
  - `payed = price`
  - номер становится “Занят” и `cleaned=false`
- Выселить (check-out):
  - `booking.book_status = “Выселен”`
  - номер становится “Свободен” и `cleaned=false`
- Сменить номер (только если статус “Заселен”):
  - разрешено только на такой же тип или выше
  - при смене номера обновляется `checkin.room`
  - старый номер освобождается, новый становится занят
  - если тип изменился — пересчитывается `price` и `payed = price`

**Используемые API endpoints:**
- `GET /api/admin/bookings/` — список бронирований
- `PATCH /api/admin/bookings/{id}/` — редактирование даты/статуса
- `POST /api/admin/bookings/{id}/checkin/` — заселить (назначить `room_id`)
- `POST /api/admin/bookings/{id}/checkout/` — выселить
- `POST /api/admin/bookings/{id}/change-room/` — сменить номер
- `GET /api/admin/rooms/` — список номеров (для выбора `room_id`)

#### 4.8. Админ: Персонал (AdminStaff.vue)
Реализован интерфейс управления уборщиками и уборками.

**Блок “Уборщики”:**
- Пагинация списка уборщиков
- Статистика уборок за период (`start`/`end`) по каждому уборщику
- Увольнение: деактивация аккаунта (`user.is_active=false`) + удаление токена  
  После увольнения уборщик не может войти

**Блок “Уборки”:**
- Пагинация списка уборок
- Фильтры: дата, номер, уборщик (`staff_id`)
- Изменение статуса уборки
- При изменении статуса синхронизируется `RoomInHotel.cleaned`

**Используемые API endpoints:**
- `GET /api/admin/cleaners/` — список уборщиков
- `GET /api/admin/cleaners/{staff_id}/stats/?start=…&end=…` — статистика
- `POST /api/admin/cleaners/{staff_id}/fire/` — уволить
- `GET /api/admin/cleanings/?date=…&room_number=…&staff_id=…` — список уборок
- `PATCH /api/admin/cleanings/{id}/` — изменить статус уборки

---

### 5. Архитектура клиентского приложения

#### 5.1. API слой (Axios)
Реализован централизованный HTTP-клиент (`src/api/http.js`):

- `baseURL = http://127.0.0.1:8000`
- Интерцептор запросов:
  - автоматическое добавление заголовка `Authorization: Token <token>` при наличии токена
- Интерцептор ответов:
  - обработка `401` — сброс авторизации и редирект на `/login` (при необходимости)

#### 5.2. Store аутентификации (authStore)
Хранит: `token`, `role`  
Методы: `setToken`, `clearAuth`, загрузка состояния из `localStorage`  
Используется `AppHeader` для отображения меню по ролям.

#### 5.3. Маршрутизация (router/index.js)
Реализованы маршруты по ролям:

- `/` — отели (client)
- `/hotels/:id` — отель
- `/hotels/:hotelId/types/:typeId` — тип номера
- `/login` — вход
- `/register` — выбор регистрации
- `/register/client` — регистрация клиента
- `/register/staff` — регистрация персонала
- `/profile` — профиль
- `/cleaner` — уборки (cleaner)
- `/admin/rooms` — номера (admin)
- `/admin/checkins` — заселения (admin)
- `/admin/staff` — персонал (admin)

**Guard по ролям:**
- Если пользователь не авторизован → `/login`
- Если роль не подходит под маршрут → редирект на главную по роли

---

## 6. Заключение
В ходе лабораторной работы №4 была реализована полноценная клиентская часть для гостиничной системы на Vue.js:

- Настроено взаимодействие с сервером через CORS
- Реализованы интерфейсы регистрации и входа с токенами
- Добавлены роли (client/cleaner/admin) и разная логика отображения
- Реализованы клиентские экраны для всех ролей: бронирование, уборки, админ-панель
- Добавлены пагинация и фильтрация во всех ключевых списках
- Обеспечена синхронизация данных между сущностями (номер ↔ уборка, номер ↔ бронирование, бронь ↔ заселение)